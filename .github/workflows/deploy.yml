name: Build and Push Docker Image

on:
  push:
    branches:
      - main  # Ensure this matches your branch name

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    # Build Docker image using Kaniko
    - name: Build and push Docker image using Kaniko
      env:
        DOCKER_CONFIG: /kaniko/.docker/  # Kaniko expects Docker credentials here
        DOCKER_USERNAME: ${{ secrets.uname }}  # Docker Hub username secret
        DOCKER_TOKEN: ${{ secrets.dtoken }}  # Docker Hub token secret
      run: |
        mkdir -p /kaniko/.docker
        echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"username\":\"$DOCKER_USERNAME\",\"password\":\"$DOCKER_TOKEN\"}}}" > /kaniko/.docker/config.json
        
        # Run the Kaniko executor directly using the Kaniko image
        docker run --rm -v "${{ github.workspace }}:/workspace" \
          -v "/kaniko/.docker:/kaniko/.docker" \
          gcr.io/kaniko-project/executor:latest \
          --context=/workspace \
          --dockerfile=/workspace/Dockerfile \
          --destination=shivtestac/kan:tagname
